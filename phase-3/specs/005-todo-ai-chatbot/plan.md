# Implementation Plan: Todo AI Chatbot (Phase-3)

**Branch**: `005-todo-ai-chatbot` | **Date**: 2026-01-02 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/005-todo-ai-chatbot/spec.md`

## Summary

Implement an AI-powered chat interface that allows users to manage their tasks through natural language conversation. The system uses OpenAI Agents SDK with MCP (Model Context Protocol) tools for task operations, ChatKit for the UI, and maintains full statelessness with PostgreSQL-backed conversation persistence.

## Technical Context

**Language/Version**: Python 3.11 (backend), TypeScript 5 (frontend)
**Primary Dependencies**:
  - Backend: FastAPI >=0.115.0, OpenAI SDK >=1.0.0, MCP SDK >=1.0.0, SQLModel
  - Frontend: Next.js 16, React 19, @chatscope/chat-ui-kit-react
**Storage**: PostgreSQL (existing) + new Conversation/Message tables
**Testing**: pytest (backend), Jest/React Testing Library (frontend)
**Target Platform**: Web application (desktop/mobile browsers)
**Project Type**: Web application with separate frontend/backend
**Performance Goals**: <5s AI response time, 100 concurrent chat sessions
**Constraints**: Stateless server (no in-memory state), JWT authentication required
**Scale/Scope**: Single user conversations, ~1000 messages per user

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Pre-Design Status | Post-Design Status |
|-----------|-------------------|-------------------|
| I. Data Integrity First | âœ… Messages stored atomically | âœ… DB transactions for all writes |
| II. Offline-First | âš ï¸ Partial - chat requires network | âš ï¸ Queue failed sends on frontend |
| III. User Experience | âœ… <5s target, loading states | âœ… TypingIndicator, error messages |
| IV. TDD | ðŸ”² Tests required | ðŸ”² Test plan in tasks.md |
| V. Security & Privacy | âœ… JWT auth, user isolation | âœ… user_id validation on all tools |
| VI. Performance Budget | âœ… Async operations | âœ… Message pagination supported |

**Offline-First Exception**: Chat functionality inherently requires network for AI processing. Constitution allows graceful degradation with clear feedback. Frontend will queue failed message sends and display sync status.

## Project Structure

### Documentation (this feature)

```text
specs/005-todo-ai-chatbot/
â”œâ”€â”€ plan.md              # This file
â”œâ”€â”€ spec.md              # Feature requirements
â”œâ”€â”€ research.md          # Technology decisions
â”œâ”€â”€ data-model.md        # Database schema
â”œâ”€â”€ quickstart.md        # Implementation guide
â”œâ”€â”€ contracts/
â”‚   â”œâ”€â”€ chat-api.yaml    # OpenAPI specification
â”‚   â””â”€â”€ mcp-tools.yaml   # MCP tool definitions
â”œâ”€â”€ checklists/
â”‚   â””â”€â”€ requirements.md  # Quality checklist
â””â”€â”€ tasks.md             # Generated by /sp.tasks
```

### Source Code (repository root)

```text
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ task.py          # Existing (add description field)
â”‚   â”‚   â”œâ”€â”€ conversation.py  # NEW: Conversation model
â”‚   â”‚   â””â”€â”€ message.py       # NEW: Message model
â”‚   â”œâ”€â”€ mcp/
â”‚   â”‚   â”œâ”€â”€ __init__.py      # NEW: MCP module init
â”‚   â”‚   â””â”€â”€ tools.py         # NEW: MCP tool implementations
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ agent.py         # NEW: OpenAI agent service
â”‚   â”œâ”€â”€ api/routes/
â”‚   â”‚   â”œâ”€â”€ tasks.py         # Existing
â”‚   â”‚   â”œâ”€â”€ health.py        # Existing
â”‚   â”‚   â””â”€â”€ chat.py          # NEW: Chat endpoints
â”‚   â””â”€â”€ schemas/
â”‚       â””â”€â”€ chat.py          # NEW: Chat request/response schemas
â”œâ”€â”€ alembic/versions/
â”‚   â””â”€â”€ xxx_add_chat.py      # NEW: Migration for conversations/messages
â””â”€â”€ tests/
    â”œâ”€â”€ test_mcp_tools.py    # NEW: MCP tool unit tests
    â””â”€â”€ test_chat.py         # NEW: Chat endpoint integration tests

frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â”‚   â”œâ”€â”€ chat-container.tsx   # NEW: Main chat wrapper
â”‚   â”‚   â”‚   â”œâ”€â”€ message-list.tsx     # NEW: Message display
â”‚   â”‚   â”‚   â”œâ”€â”€ message-input.tsx    # NEW: User input
â”‚   â”‚   â”‚   â””â”€â”€ typing-indicator.tsx # NEW: Loading state
â”‚   â”‚   â””â”€â”€ tasks/                   # Existing (may deprecate)
â”‚   â”œâ”€â”€ app/(dashboard)/
â”‚   â”‚   â”œâ”€â”€ dashboard/page.tsx       # Existing
â”‚   â”‚   â””â”€â”€ chat/
â”‚   â”‚       â””â”€â”€ page.tsx             # NEW: Chat page
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â””â”€â”€ use-chat.ts              # NEW: Chat hook
â”‚   â””â”€â”€ lib/
â”‚       â”œâ”€â”€ api.ts                   # Existing
â”‚       â””â”€â”€ chat-api.ts              # NEW: Chat API client
â””â”€â”€ __tests__/
    â””â”€â”€ chat/                        # NEW: Chat component tests
```

**Structure Decision**: Web application with existing backend/frontend separation. New modules added to each side for chat functionality.

## Implementation Phases

### Phase 3.1: Backend Database & Models

**Goal**: Add database infrastructure for conversations and messages

**Tasks**:
1. Create `Conversation` SQLModel in `backend/app/models/conversation.py`
2. Create `Message` SQLModel in `backend/app/models/message.py`
3. Add `description` field to existing `Task` model
4. Generate Alembic migration for new tables
5. Run migration and verify schema

**Deliverables**:
- `conversation.py`, `message.py` models
- Alembic migration file
- Updated `Task` model

---

### Phase 3.2: MCP Tools Implementation

**Goal**: Implement stateless MCP tools for task operations

**Tasks**:
1. Create MCP tools module `backend/app/mcp/tools.py`
2. Implement `add_task` tool
3. Implement `list_tasks` tool
4. Implement `complete_task` tool with title matching
5. Implement `update_task` tool
6. Implement `delete_task` tool
7. Write unit tests for each tool

**Deliverables**:
- `tools.py` with 5 MCP tool implementations
- `test_mcp_tools.py` with unit tests

---

### Phase 3.3: OpenAI Agent Service

**Goal**: Implement AI agent with tool calling capability

**Tasks**:
1. Create agent service `backend/app/services/agent.py`
2. Implement OpenAI client initialization
3. Implement conversation context building from message history
4. Implement tool calling loop
5. Implement response generation
6. Add error handling and retries

**Deliverables**:
- `agent.py` with OpenAI integration
- Tool calling loop implementation

---

### Phase 3.4: Chat API Endpoints

**Goal**: Create REST endpoints for chat functionality

**Tasks**:
1. Create chat schemas `backend/app/schemas/chat.py`
2. Create chat routes `backend/app/api/routes/chat.py`
3. Implement `POST /{user_id}/chat` endpoint
4. Implement `GET /{user_id}/chat/history` endpoint
5. Add JWT validation and user_id verification
6. Register routes in main app
7. Write integration tests

**Deliverables**:
- `chat.py` schemas and routes
- Integration tests in `test_chat.py`

---

### Phase 3.5: Frontend Chat UI

**Goal**: Build chat interface using ChatKit

**Tasks**:
1. Install @chatscope/chat-ui-kit-react
2. Create `ChatContainer` component
3. Create `MessageList` component
4. Create `MessageInput` component
5. Create `TypingIndicator` component
6. Create chat API client `lib/chat-api.ts`
7. Create `useChat` hook for state management
8. Create chat page at `/dashboard/chat`
9. Add navigation to chat from dashboard
10. Style components to match existing design

**Deliverables**:
- Chat component suite
- Chat page
- API client and hook

---

### Phase 3.6: Integration & Validation

**Goal**: End-to-end testing and validation

**Tasks**:
1. Write E2E tests for complete chat flow
2. Test conversation persistence across sessions
3. Test tool chaining (multiple tools in one conversation)
4. Verify statelessness (server restart doesn't lose state)
5. Load test with concurrent users
6. Fix any issues discovered

**Deliverables**:
- E2E test suite
- Performance test results
- Bug fixes

## Complexity Tracking

> No constitution violations requiring justification.

| Aspect | Decision | Rationale |
|--------|----------|-----------|
| Single AI provider | OpenAI only | Spec requirement, simplifies implementation |
| Single conversation per user | UNIQUE constraint | Spec assumption, can extend later |
| ChatKit vs custom | ChatKit | Faster development, proven components |

## Dependencies

```mermaid
graph TD
    A[Phase 3.1: Database Models] --> B[Phase 3.2: MCP Tools]
    A --> C[Phase 3.3: Agent Service]
    B --> C
    C --> D[Phase 3.4: Chat API]
    D --> E[Phase 3.5: Frontend UI]
    E --> F[Phase 3.6: Validation]
```

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| OpenAI rate limits | Medium | High | Implement retry with backoff, cache responses |
| Slow AI responses | Medium | Medium | Streaming responses, timeout handling |
| Token costs | Low | Medium | Use GPT-4o-mini, limit context window |
| MCP SDK compatibility | Low | Medium | Fall back to custom tool format |

## Success Metrics

From spec:
- SC-001: AI response within 5 seconds âœ… Monitored via logging
- SC-002: 90% task add success rate âœ… Tracked via tool call results
- SC-005: Conversation persistence âœ… Tested in Phase 3.6
- SC-007: 100 concurrent sessions âœ… Load tested in Phase 3.6

## Next Steps

Run `/sp.tasks` to generate the detailed task list with test cases for implementation.
