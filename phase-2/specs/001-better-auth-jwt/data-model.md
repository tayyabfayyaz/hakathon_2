# Data Model: Better Auth with JWT Authentication

## Entity Relationship Diagram

```
┌─────────────────────┐       ┌─────────────────────┐
│        user         │       │       session       │
├─────────────────────┤       ├─────────────────────┤
│ id (PK)             │◄──────│ userId (FK)         │
│ name                │       │ id (PK)             │
│ email (unique)      │       │ token               │
│ emailVerified       │       │ expiresAt           │
│ image               │       │ ipAddress           │
│ createdAt           │       │ userAgent           │
│ updatedAt           │       │ createdAt           │
└─────────────────────┘       │ updatedAt           │
         │                    └─────────────────────┘
         │
         │                    ┌─────────────────────┐
         │                    │      account        │
         └───────────────────►├─────────────────────┤
                              │ id (PK)             │
                              │ userId (FK)         │
                              │ accountId           │
                              │ providerId          │
                              │ accessToken         │
                              │ refreshToken        │
                              │ accessTokenExpiresAt│
                              │ refreshTokenExpiresAt│
                              │ scope               │
                              │ password (hashed)   │
                              │ createdAt           │
                              │ updatedAt           │
                              └─────────────────────┘

┌─────────────────────┐
│    verification     │
├─────────────────────┤
│ id (PK)             │
│ identifier          │
│ value               │
│ expiresAt           │
│ createdAt           │
│ updatedAt           │
└─────────────────────┘
```

## Entity Definitions

### User (Better Auth Managed)

The primary user entity managed by Better Auth.

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | string | PK | Unique user identifier |
| name | string | nullable | Display name |
| email | string | unique, not null | User's email address |
| emailVerified | boolean | default: false | Whether email is verified |
| image | string | nullable | Profile image URL |
| createdAt | datetime | not null | Account creation timestamp |
| updatedAt | datetime | not null | Last update timestamp |

### Session (Better Auth Managed)

Active user sessions for tracking authenticated users.

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | string | PK | Unique session identifier |
| userId | string | FK → user.id | Associated user |
| token | string | unique, not null | Session token (JWT or opaque) |
| expiresAt | datetime | not null | Session expiration time |
| ipAddress | string | nullable | Client IP address |
| userAgent | string | nullable | Browser/client info |
| createdAt | datetime | not null | Session creation time |
| updatedAt | datetime | not null | Last activity time |

### Account (Better Auth Managed)

Links users to authentication providers (including email/password).

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | string | PK | Unique account identifier |
| userId | string | FK → user.id | Associated user |
| accountId | string | not null | Provider-specific user ID |
| providerId | string | not null | Provider name (e.g., "credential", "google") |
| accessToken | string | nullable | OAuth access token |
| refreshToken | string | nullable | OAuth refresh token |
| accessTokenExpiresAt | datetime | nullable | Token expiration |
| refreshTokenExpiresAt | datetime | nullable | Refresh token expiration |
| scope | string | nullable | OAuth scopes |
| password | string | nullable | Hashed password (for credential provider) |
| createdAt | datetime | not null | Account creation time |
| updatedAt | datetime | not null | Last update time |

### Verification (Better Auth Managed)

Stores verification tokens for email verification, password reset, etc.

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | string | PK | Unique verification ID |
| identifier | string | not null | What is being verified (email, etc.) |
| value | string | not null | Verification token value |
| expiresAt | datetime | not null | Token expiration |
| createdAt | datetime | not null | Token creation time |
| updatedAt | datetime | not null | Last update time |

## Validation Rules

### User Entity
- `email`: Must be valid email format, max 255 characters, unique across system
- `name`: Optional, max 100 characters if provided

### Session Entity
- `token`: Generated by Better Auth, cryptographically secure
- `expiresAt`: Must be in the future, default 7 days from creation

### Account Entity
- `providerId`: Must be a configured provider ("credential" for email/password)
- `password`: When providerId="credential", must be bcrypt hashed

## State Transitions

### Session Lifecycle

```
[No Session] ──login──► [Active Session] ──expires──► [Expired]
                              │
                              │──logout──► [Invalidated]
                              │
                              │──refresh──► [Active Session] (new token)
```

### User Registration Flow

```
[New User Request]
       │
       ▼
[Validate Email/Password]
       │
       ├──invalid──► [Return Validation Error]
       │
       ▼
[Create User Record]
       │
       ▼
[Create Account (credential)]
       │
       ▼
[Create Session]
       │
       ▼
[Return JWT Token]
```

## Migration from Current Schema

### Current User Table
```sql
-- Existing schema
CREATE TABLE users (
    id UUID PRIMARY KEY,
    email VARCHAR(255) UNIQUE,
    password_hash VARCHAR(255),
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    last_login_at TIMESTAMP
);
```

### Migration Strategy
1. **Option A (Recommended)**: Let Better Auth create new tables, migrate existing users
2. **Option B**: Adapt existing table to Better Auth schema

### Migration Script (Conceptual)
```sql
-- Step 1: Create Better Auth tables
-- (Better Auth CLI handles this)

-- Step 2: Migrate existing users
INSERT INTO "user" (id, email, emailVerified, createdAt, updatedAt)
SELECT
    id::text,
    email,
    true,  -- Assume verified for existing users
    created_at,
    updated_at
FROM users;

-- Step 3: Create account records for existing users
INSERT INTO account (id, userId, accountId, providerId, password, createdAt, updatedAt)
SELECT
    gen_random_uuid()::text,
    id::text,
    id::text,
    'credential',
    password_hash,
    created_at,
    updated_at
FROM users;
```

## Index Recommendations

| Table | Index | Columns | Purpose |
|-------|-------|---------|---------|
| user | idx_user_email | email | Fast email lookup for login |
| session | idx_session_token | token | Token validation |
| session | idx_session_user | userId | List user sessions |
| account | idx_account_user | userId | Find user accounts |
| account | idx_account_provider | providerId, accountId | Provider lookup |
