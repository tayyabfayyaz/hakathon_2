# Implementation Plan: Better Auth with JWT Token Authentication

**Feature Branch**: `001-better-auth-jwt`
**Created**: 2025-12-29
**Status**: Ready for Implementation
**Spec**: [spec.md](./spec.md)

## Technical Context

### Current State
- Backend uses `python-jose` for JWT creation/verification
- Authentication implemented in `backend/src/core/security.py`
- Session managed via httpOnly cookies
- User model exists in `backend/src/models/user.py`

### Target State
- Better Auth manages authentication on Next.js frontend
- Frontend handles sign-up, sign-in, sign-out flows
- JWT tokens generated by Better Auth
- FastAPI backend verifies Better Auth JWT tokens
- Shared secret between frontend and backend

### Technology Choices

| Component | Current | Target | Rationale |
|-----------|---------|--------|-----------|
| Frontend Auth | Custom API calls | Better Auth | Comprehensive auth library with built-in flows |
| Backend Auth | python-jose | python-jose (verify only) | Keep existing, just verify Better Auth tokens |
| Session Storage | httpOnly cookie | httpOnly cookie | No change, Better Auth uses same pattern |
| Token Format | Custom JWT | Better Auth JWT | Standard format, verified by both services |

## Constitution Check

### Compliance Status

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Input Validation | ✅ PASS | Better Auth handles validation; FastAPI validates on protected endpoints |
| II. API Design | ✅ PASS | REST conventions maintained; OpenAPI spec in contracts/ |
| III. Data Integrity | ✅ PASS | SQLModel patterns; Better Auth manages its tables |
| IV. Error Handling | ✅ PASS | Structured JSON errors; consistent format |
| V. Testing Discipline | ✅ PASS | Auth flows are critical paths - tests required |
| VI. Simplicity | ✅ PASS | Better Auth reduces custom code; justified complexity |

### Gate Evaluation

| Gate | Decision | Justification |
|------|----------|---------------|
| New dependency justified? | ✅ YES | Better Auth provides comprehensive auth vs. building custom |
| Complexity necessary? | ✅ YES | Auth is security-critical; proven library preferred |
| Integration tested? | ⏳ PENDING | Tests to be created during implementation |

## Implementation Phases

### Phase 1: Frontend - Better Auth Setup (P1)

**Goal**: Install and configure Better Auth on Next.js frontend

**Tasks**:
1. Install `better-auth` package
2. Create auth configuration (`lib/auth.ts`)
3. Create auth client for React (`lib/auth-client.ts`)
4. Add API route handler (`app/api/auth/[...all]/route.ts`)
5. Configure environment variables

**Files to Create/Modify**:
- `frontend/lib/auth.ts` (new)
- `frontend/lib/auth-client.ts` (new)
- `frontend/app/api/auth/[...all]/route.ts` (new)
- `frontend/.env.local` (modify)
- `frontend/package.json` (modify)

**Acceptance Criteria**:
- Better Auth endpoints respond at `/api/auth/*`
- Sign-up creates user in database
- Sign-in returns session with JWT token
- Token is set in httpOnly cookie

### Phase 2: Backend - JWT Verification Update (P1)

**Goal**: Update FastAPI to verify Better Auth JWT tokens

**Tasks**:
1. Update `security.py` to use Better Auth secret
2. Modify `deps.py` to extract token from Better Auth cookie
3. Update cookie name to match Better Auth convention
4. Add fallback to Authorization header

**Files to Modify**:
- `backend/src/core/security.py`
- `backend/src/api/deps.py`
- `backend/src/core/config.py`
- `backend/.env`

**Acceptance Criteria**:
- FastAPI accepts Better Auth tokens
- Token verification uses shared secret
- Protected endpoints work with Better Auth sessions
- Clear error messages for invalid tokens

### Phase 3: Frontend - Auth UI Components (P1)

**Goal**: Update frontend components to use Better Auth

**Tasks**:
1. Update `LoginForm.tsx` to use `signIn.email()`
2. Update `RegisterForm.tsx` to use `signUp.email()`
3. Update `AuthContext.tsx` to use `useSession()`
4. Update `Header.tsx` logout to use `signOut()`
5. Remove old API calls to `/auth/*` endpoints

**Files to Modify**:
- `frontend/src/components/auth/LoginForm.tsx`
- `frontend/src/components/auth/RegisterForm.tsx`
- `frontend/src/contexts/AuthContext.tsx`
- `frontend/src/components/layout/Header.tsx`
- `frontend/src/hooks/useAuth.ts`
- `frontend/src/lib/auth.ts` (remove old auth functions)

**Acceptance Criteria**:
- Login form works with Better Auth
- Registration form works with Better Auth
- Session state reflected correctly
- Logout clears session

### Phase 4: Database Migration (P1)

**Goal**: Migrate existing users to Better Auth schema

**Tasks**:
1. Let Better Auth create required tables
2. Create migration script for existing users
3. Map existing password hashes to account table
4. Verify user data integrity

**Files to Create**:
- `backend/alembic/versions/002_better_auth_migration.py`
- `scripts/migrate_users_to_better_auth.sql`

**Acceptance Criteria**:
- Better Auth tables created
- Existing users can login with old passwords
- No data loss during migration
- Rollback script available

### Phase 5: Token Refresh & Logout (P2)

**Goal**: Implement token refresh and proper logout

**Tasks**:
1. Configure Better Auth session refresh
2. Update frontend to handle token expiration
3. Implement logout that invalidates session
4. Add "logout everywhere" functionality

**Files to Modify**:
- `frontend/lib/auth.ts`
- `frontend/src/hooks/useAuth.ts`
- `frontend/src/contexts/AuthContext.tsx`

**Acceptance Criteria**:
- Tokens refresh automatically before expiry
- Expired tokens trigger re-auth prompt
- Logout invalidates current session
- Option to logout from all devices

### Phase 6: Testing (P1)

**Goal**: Comprehensive tests for authentication flows

**Tasks**:
1. Frontend: Test sign-up, sign-in, sign-out flows
2. Backend: Test JWT verification with valid/invalid tokens
3. Integration: End-to-end auth flow tests
4. Security: Test token expiration, invalid tokens

**Files to Create**:
- `frontend/__tests__/auth.test.ts`
- `backend/tests/test_better_auth.py`
- `e2e/auth.spec.ts` (if using Playwright)

**Acceptance Criteria**:
- All critical auth paths have tests
- Token validation edge cases covered
- Integration tests pass

## Risk Mitigation

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Secret mismatch | Low | High | Startup validation, shared env var |
| Token format change | Low | High | Pin Better Auth version, test upgrades |
| Session cookie issues | Medium | Medium | Test cross-origin, configure SameSite |
| Migration data loss | Low | High | Backup first, test migration, rollback ready |

## Dependencies

### External
- `better-auth` npm package
- Same PostgreSQL database for both services
- Shared environment variable for JWT secret

### Internal
- Existing User model (migration needed)
- Current auth endpoints (to be deprecated)
- Protected task endpoints (update token verification)

## Rollback Plan

If issues arise:
1. Keep old auth endpoints disabled (not deleted) until stable
2. Database migration is additive, can coexist
3. Feature flag to switch between auth systems
4. Rollback: revert frontend, re-enable old endpoints

## Artifacts Generated

| Artifact | Path | Purpose |
|----------|------|---------|
| Research | `specs/001-better-auth-jwt/research.md` | Technical decisions |
| Data Model | `specs/001-better-auth-jwt/data-model.md` | Entity definitions |
| API Contract | `specs/001-better-auth-jwt/contracts/auth-api.yaml` | OpenAPI spec |
| Quickstart | `specs/001-better-auth-jwt/quickstart.md` | Implementation guide |

## Next Steps

1. Run `/sp.tasks` to generate implementation task list
2. Create feature branch and start Phase 1
3. Test incrementally after each phase
